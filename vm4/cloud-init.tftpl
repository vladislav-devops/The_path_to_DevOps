#cloud-config
# ðŸš€ Cloud-init ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ VM4

# ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
hostname: ${hostname}
manage_etc_hosts: true

# ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸
users:
  - name: ${username}
    groups: [adm, sudo]
    lock_passwd: false
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    plain_text_passwd: ${password}
    chpasswd: { expire: false }
    ssh_authorized_keys:
      - ${ssh_public_key}

# SSH Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
ssh_pwauth: ${ssh_password_auth}
disable_root: false
ssh_import_id: []

# SSH ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
ssh:
  emit_keys_to_console: false

# Ð¡ÐµÑ‚ÐµÐ²Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
write_files:
  - path: /etc/netplan/01-netcfg.yaml
    content: |
      network:
        version: 2
        ethernets:
          ens18:
            dhcp4: false
            addresses: [${vm_ip_address}/24]
            gateway4: ${vm_gateway}
            nameservers:
              addresses: [8.8.8.8, 1.1.1.1]
    permissions: '0644'

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
package_update: true
package_upgrade: true

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
packages:
  - curl
  - wget
  - git
  - vim
  - htop
  - net-tools
  - qemu-guest-agent
  - unzip
  - tree
  - nano
  - docker.io
  - docker-compose
  - ca-certificates
  - lsb-release
  - gnupg

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
write_files:
  - content: |
      #!/bin/bash
      echo "ðŸš€ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° VM4..."
      
      # Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ»ÑƒÐ¶Ð±Ñ‹
      systemctl enable qemu-guest-agent
      systemctl start qemu-guest-agent
      systemctl enable ssh
      systemctl start ssh
      
      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSH
      %{ if ssh_password_auth }
      sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
      sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
      %{ else }
      sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
      sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
      %{ endif }
      systemctl restart ssh
      
      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐµÑ‚Ð¸
      netplan apply
      
      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° firewall
      ufw allow ssh
      ufw allow 3000/tcp  # Grafana
      ufw allow 9090/tcp  # Prometheus
      ufw allow 9100/tcp  # Node Exporter
      ufw --force enable
      
      # Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ IP ÐµÑÐ»Ð¸ DHCP Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
      if ! ip route | grep default; then
          ip addr add ${vm_ip_address}/24 dev ens18
          ip route add default via ${vm_gateway}
      fi
      
      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ welcome Ñ„Ð°Ð¹Ð»Ð¾Ð²
      echo "VM4 server ready!" > /home/${username}/welcome.txt
      echo "SSH: ${username}@${vm_ip_address}" >> /home/${username}/welcome.txt
      echo "Password: ${password}" >> /home/${username}/welcome.txt
      chown ${username}:${username} /home/${username}/welcome.txt
      chmod 644 /home/${username}/welcome.txt
      
      # Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð² SSH
      if [ -d "/home/${username}/.ssh" ]; then
          chmod 700 /home/${username}/.ssh
          chmod 600 /home/${username}/.ssh/authorized_keys
          chown -R ${username}:${username} /home/${username}/.ssh
      fi
      
      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Docker
      systemctl enable docker
      systemctl start docker
      usermod -aG docker ${username}
      
      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ docker-compose.yml Ð´Ð»Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
      mkdir -p /home/${username}/monitoring
      cat > /home/${username}/monitoring/docker-compose.yml << 'EOF'
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_SECURITY_ADMIN_USER=admin

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'

volumes:
  prometheus_data:
  grafana_data:
EOF

      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Prometheus
      mkdir -p /home/${username}/monitoring/prometheus
      cat > /home/${username}/monitoring/prometheus/prometheus.yml << 'EOF'
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
      
  - job_name: 'vm4-node'
    static_configs:
      - targets: ['${vm_ip_address}:9100']
EOF

      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð°Ð·Ð¾Ð²Ð¾Ð¹ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Grafana
      mkdir -p /home/${username}/monitoring/grafana/provisioning/datasources
      cat > /home/${username}/monitoring/grafana/provisioning/datasources/prometheus.yml << 'EOF'
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
EOF

      # Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð² Ð´Ð»Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
      chown -R ${username}:${username} /home/${username}/monitoring
      
      echo "âœ… VM4 Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ñ Grafana Ð¸ Prometheus!"
      echo "ðŸ” SSH: ${username}@${vm_ip_address}"
      echo "ðŸ”‘ Password: ${password}"
      echo "ðŸ“Š Grafana: http://${vm_ip_address}:3000 (admin/admin123)"
      echo "ðŸ“ˆ Prometheus: http://${vm_ip_address}:9090"
    path: /tmp/setup-vm4.sh
    permissions: '0755'

# ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ
runcmd:
  - /tmp/setup-vm4.sh
  - sleep 30
  - cd /home/devops/monitoring && docker-compose up -d

# Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
final_message: "ðŸš€ VM4 server is ready! Login with: ssh ${username}@${vm_ip_address}"

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº
power_state:
  delay: "+1"
  mode: reboot
  message: "ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° VM4 Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ SSH Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº"
  condition: true