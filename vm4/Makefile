# üöÄ VM4 Makefile –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

.PHONY: help init plan apply destroy test-ssh test-ping clean status deploy-and-test

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN := \033[32m
BLUE := \033[34m
YELLOW := \033[33m
RED := \033[31m
NC := \033[0m

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
	@echo "$(BLUE)üöÄ VM4 - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–æ–π$(NC)"
	@echo ""
	@echo "$(GREEN)–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

init: ## –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Terraform
	@echo "$(BLUE)üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Terraform...$(NC)"
	terraform init

plan: ## –ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–∞–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
	@echo "$(BLUE)üìã –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è...$(NC)"
	terraform plan

apply: ## –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å VM
	@echo "$(BLUE)üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ VM4...$(NC)"
	terraform apply -auto-approve
	@echo "$(GREEN)‚úÖ VM4 —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞!$(NC)"

test-ping: ## –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ —Å–µ—Ç–∏
	@echo "$(BLUE)üèì –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏...$(NC)"
	@VM_IP=$$(terraform output -raw vm4_info 2>/dev/null | jq -r '.ip_address' 2>/dev/null || echo "192.168.88.140"); \
	if ping -c 3 $$VM_IP > /dev/null 2>&1; then \
		echo "$(GREEN)‚úÖ VM –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É $$VM_IP$(NC)"; \
	else \
		echo "$(RED)‚ùå VM –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É $$VM_IP$(NC)"; \
		exit 1; \
	fi

test-ssh: ## –ü–æ–ª–Ω–æ–µ SSH —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
	@echo "$(BLUE)üîê SSH —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...$(NC)"
	./test-ssh.sh

status: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å VM
	@echo "$(BLUE)üìä –°—Ç–∞—Ç—É—Å VM4:$(NC)"
	@terraform output vm4_info 2>/dev/null || echo "$(YELLOW)VM –Ω–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞$(NC)"

deploy-and-test: init apply test-ping test-ssh ## –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
	@echo "$(GREEN)üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!$(NC)"

destroy: ## –£–¥–∞–ª–∏—Ç—å VM
	@echo "$(RED)üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ VM4...$(NC)"
	terraform destroy -auto-approve
	@echo "$(YELLOW)VM4 —É–¥–∞–ª–µ–Ω–∞$(NC)"

clean: ## –û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã Terraform
	@echo "$(BLUE)üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤...$(NC)"
	rm -rf .terraform
	rm -f .terraform.lock.hcl
	rm -f terraform.tfstate*

# –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã
quick-deploy: apply test-ping ## –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å –±–∞–∑–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
	@echo "$(GREEN)‚ö° –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!$(NC)"

recreate: destroy deploy-and-test ## –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å VM —Å –ø–æ–ª–Ω—ã–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
	@echo "$(GREEN)üîÑ VM –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞!$(NC)"