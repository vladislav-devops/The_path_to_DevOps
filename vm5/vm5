#!/bin/bash
# ğŸš€ VM5 Smart Task Runner
# Automatically uses just or make based on availability

set -euo pipefail

# Colors
BLUE='\033[34m'
GREEN='\033[32m'
YELLOW='\033[33m'
NC='\033[0m'

# Check for available task runners
has_just() {
    command -v just >/dev/null 2>&1
}

has_make() {
    command -v make >/dev/null 2>&1
}

show_help() {
    echo -e "${BLUE}ğŸš€ VM5 Enhanced - Smart Task Runner${NC}"
    echo ""
    echo -e "${GREEN}Available task runners:${NC}"
    
    if has_just; then
        echo -e "  âœ… just (preferred) - Modern task runner"
    else
        echo -e "  âŒ just - Not installed"
    fi
    
    if has_make; then
        echo -e "  âœ… make - Traditional task runner"
    else
        echo -e "  âŒ make - Not available"
    fi
    
    echo ""
    echo -e "${BLUE}Usage:${NC}"
    echo "  ./vm5 <command> [args...]"
    echo ""
    echo -e "${BLUE}Installation:${NC}"
    
    if ! has_just; then
        echo -e "  ${YELLOW}Install just for better experience:${NC}"
        echo "    brew install just"
        echo ""
    fi
    
    if has_just; then
        echo -e "${GREEN}Using just (recommended):${NC}"
        just --list
    elif has_make; then
        echo -e "${YELLOW}Using make (fallback):${NC}"
        make help
    else
        echo -e "${RED}âŒ No task runner available!${NC}"
        echo "Install just or make to continue."
        exit 1
    fi
}

# Main logic
if [[ $# -eq 0 ]] || [[ "$1" == "help" ]] || [[ "$1" == "--help" ]]; then
    show_help
    exit 0
fi

# Route to appropriate task runner
if has_just; then
    echo -e "${BLUE}ğŸš€ Using just...${NC}"
    just "$@"
elif has_make; then
    echo -e "${YELLOW}ğŸ“œ Using make (fallback)...${NC}"
    # Map some just commands to make equivalents
    case "$1" in
        "quick-deploy")
            make quick-deploy
            ;;
        "ssh")
            make ssh
            ;;
        "monitor-all")
            make monitor-all
            ;;
        "test-ssh")
            make test-ssh
            ;;
        "deploy-and-test")
            make deploy-and-test
            ;;
        *)
            # Try direct mapping
            if make -q "$1" 2>/dev/null; then
                make "$@"
            else
                echo -e "\033[31mâŒ Command '$1' not available in make\033[0m"
                echo "Available make commands:"
                make help
                exit 1
            fi
            ;;
    esac
else
    echo -e "\033[31mâŒ No task runner available!\033[0m"
    echo "Please install just or make:"
    echo "  brew install just"
    exit 1
fi