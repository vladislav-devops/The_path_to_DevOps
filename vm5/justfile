# ğŸš€ VM5 Enhanced Task Runner
# Modern automation with justfile - clean syntax, powerful features

# ==================
# VARIABLES
# ==================

# Get values dynamically from terraform
vm_ip := `terraform output -raw vm5_info 2>/dev/null | jq -r '.ip_address' 2>/dev/null || echo "192.168.88.150"`
vm_name := `terraform output -raw vm5_info 2>/dev/null | jq -r '.name' 2>/dev/null || echo "vm5-server"`
ssh_user := `terraform output -raw vm5_info 2>/dev/null | jq -r '.username' 2>/dev/null || echo "devops"`

# Default values
terraform_dir := "."
default_target := "production"

# ==================
# MAIN COMMANDS
# ==================

# Show all available commands
@default:
    echo "ğŸš€ VM5 Enhanced - Modern Task Runner"
    echo ""
    echo "ğŸ“‹ Available commands:"
    just --list --unsorted
    echo ""
    echo "ğŸ¯ Quick start: just deploy"
    echo "ğŸ”— SSH access: just ssh"
    echo "ğŸ“Š Monitoring: just monitor"

# Deploy VM5 infrastructure with full validation
deploy validate="true":
    @echo "ğŸš€ Deploying {{vm_name}} infrastructure..."
    @if [ "{{validate}}" = "true" ]; then \
        just validate; \
    fi
    terraform init
    terraform plan
    terraform apply
    @echo "âœ… {{vm_name}} deployed successfully!"

# Quick deployment without interactive prompts
quick-deploy:
    @echo "âš¡ Quick deploy {{vm_name}} (auto-approve)..."
    terraform init -upgrade
    terraform apply -auto-approve
    @echo "ğŸ¯ Quick deployment completed!"

# Plan infrastructure changes
plan:
    @echo "ğŸ“‹ Planning {{vm_name}} changes..."
    terraform init
    terraform plan

# Validate all configurations
validate:
    @echo "ğŸ” Validating VM5 configurations..."
    terraform validate
    @echo "âœ… Terraform configuration valid"
    @if [ -f "{{terraform_dir}}/variables.tf" ]; then \
        echo "âœ… Variables file found"; \
    fi
    @if [ -f "{{terraform_dir}}/cloud-init.tftpl" ]; then \
        echo "âœ… Cloud-init template found"; \
    fi

# ==================
# CONNECTION & SSH
# ==================

# SSH into the VM
ssh:
    @echo "ğŸ” Connecting to {{vm_name}} ({{vm_ip}})..."
    ssh {{ssh_user}}@{{vm_ip}}

# Execute command on VM
ssh-exec command:
    @echo "ğŸ” Executing on {{vm_name}}: {{command}}"
    ssh {{ssh_user}}@{{vm_ip}} "{{command}}"

# Test SSH connectivity
test-ssh:
    @echo "ğŸ” Testing SSH connection to {{vm_ip}}..."
    @if ssh -o ConnectTimeout=5 -o BatchMode=yes {{ssh_user}}@{{vm_ip}} 'echo "âœ… SSH connection successful"' 2>/dev/null; then \
        echo "âœ… SSH test passed"; \
    else \
        echo "âŒ SSH connection failed"; \
        exit 1; \
    fi

# ==================
# MONITORING & HEALTH
# ==================

# Check VM health and services
health:
    @echo "ğŸ” Checking {{vm_name}} health..."
    @echo "ğŸ“Š Network connectivity:"
    @if ping -c 3 {{vm_ip}} >/dev/null 2>&1; then \
        echo "  âœ… Network reachable"; \
    else \
        echo "  âŒ Network unreachable"; \
    fi
    @echo "ğŸ“Š SSH connectivity:"
    just test-ssh
    @echo "ğŸ“Š System services:"
    just ssh-exec 'systemctl --no-pager status docker qemu-guest-agent'

# Monitor VM resources and services
monitor:
    @echo "ğŸ“Š Monitoring {{vm_name}} resources..."
    just ssh-exec 'echo "=== System Info ===" && uptime && echo && echo "=== Memory ===" && free -h && echo && echo "=== Disk ===" && df -h'

# Check Docker services status
docker-status:
    @echo "ğŸ³ Docker services on {{vm_name}}:"
    just ssh-exec 'docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'

# Monitor all services (Docker + System)
monitor-all:
    @echo "ğŸ“Š Complete monitoring for {{vm_name}}..."
    just health
    just docker-status
    @echo "ğŸ“Š Monitoring URLs:"
    @echo "  ğŸ¨ Grafana: http://{{vm_ip}}:3000"
    @echo "  ğŸ“ˆ Prometheus: http://{{vm_ip}}:9090"
    @echo "  ğŸ“Š Node Exporter: http://{{vm_ip}}:9100"

# ==================
# DOCKER & SERVICES
# ==================

# Manage Docker Compose services
compose action="status":
    @echo "ğŸ³ Docker Compose {{action}} on {{vm_name}}..."
    @if [ "{{action}}" = "up" ]; then \
        just ssh-exec 'cd monitoring && docker-compose up -d'; \
    elif [ "{{action}}" = "down" ]; then \
        just ssh-exec 'cd monitoring && docker-compose down'; \
    elif [ "{{action}}" = "restart" ]; then \
        just ssh-exec 'cd monitoring && docker-compose restart'; \
    elif [ "{{action}}" = "logs" ]; then \
        just ssh-exec 'cd monitoring && docker-compose logs -f --tail=50'; \
    else \
        just ssh-exec 'cd monitoring && docker-compose ps'; \
    fi

# Restart monitoring stack
restart-monitoring:
    @echo "ğŸ”„ Restarting monitoring stack..."
    just compose restart
    @echo "âœ… Monitoring restarted!"

# Check monitoring stack health
check-monitoring:
    @echo "ğŸ“Š Checking monitoring stack..."
    @echo "ğŸ¨ Grafana health:"
    @if curl -s -o /dev/null -w "%{http_code}" http://{{vm_ip}}:3000 | grep -q "200"; then \
        echo "  âœ… Grafana accessible"; \
    else \
        echo "  âŒ Grafana not accessible"; \
    fi
    @echo "ğŸ“ˆ Prometheus health:"
    @if curl -s http://{{vm_ip}}:9090/api/v1/status/config >/dev/null 2>&1; then \
        echo "  âœ… Prometheus API responding"; \
    else \
        echo "  âŒ Prometheus not responding"; \
    fi

# ==================
# TERRAFORM OPERATIONS
# ==================

# Show terraform outputs in a nice format
info:
    @echo "ğŸ“‹ {{vm_name}} Information:"
    @echo ""
    terraform output vm5_summary

# Show all outputs
outputs:
    @echo "ğŸ“Š All VM5 outputs:"
    terraform output

# Refresh terraform state
refresh:
    @echo "ğŸ”„ Refreshing Terraform state..."
    terraform refresh

# Import existing resources (if needed)
import resource_type resource_id:
    @echo "ğŸ“¥ Importing {{resource_type}} with ID {{resource_id}}..."
    terraform import {{resource_type}}.vm5_server {{resource_id}}

# ==================
# MAINTENANCE
# ==================

# Destroy VM infrastructure
destroy:
    @echo "ğŸ—‘ï¸  Destroying {{vm_name}} infrastructure..."
    @echo "âš ï¸  This will permanently delete the VM!"
    @read -p "Are you sure? (yes/no): " confirm; \
    if [ "$$confirm" = "yes" ]; then \
        terraform destroy; \
    else \
        echo "âŒ Destruction cancelled"; \
    fi

# Recreate VM from scratch
recreate:
    @echo "ğŸ”„ Recreating {{vm_name}} from scratch..."
    just destroy
    sleep 5
    just deploy
    just test-full
    @echo "âœ… {{vm_name}} recreated successfully!"

# Clean terraform temporary files
clean:
    @echo "ğŸ§¹ Cleaning Terraform temporary files..."
    rm -rf .terraform
    rm -f .terraform.lock.hcl
    rm -f terraform.tfstate.backup
    @echo "âœ… Cleanup completed"

# Update VM packages
update-packages:
    @echo "ğŸ“¦ Updating packages on {{vm_name}}..."
    just ssh-exec 'sudo apt update && sudo apt upgrade -y'
    @echo "âœ… Packages updated"

# ==================
# TESTING
# ==================

# Run basic connectivity tests
test-basic:
    @echo "ğŸ§ª Basic connectivity tests..."
    @echo "ğŸ“Š Network test:"
    ping -c 3 {{vm_ip}}
    @echo "ğŸ“Š SSH test:"
    just test-ssh
    @echo "âœ… Basic tests completed"

# Run comprehensive tests
test-full:
    @echo "ğŸ§ª Running full test suite for {{vm_name}}..."
    just test-basic
    just health
    just check-monitoring
    @echo "âœ… Full test suite completed"

# Benchmark VM performance
benchmark:
    @echo "âš¡ Running performance benchmark..."
    just ssh-exec 'echo "=== CPU Info ===" && nproc && echo && echo "=== Memory Test ===" && free -h && echo && echo "=== Disk Speed ===" && sudo hdparm -t /dev/sda'

# ==================
# DEVELOPMENT
# ==================

# Open monitoring dashboards
dashboards:
    @echo "ğŸ¨ Opening monitoring dashboards..."
    @echo "Opening Grafana: http://{{vm_ip}}:3000"
    @echo "Opening Prometheus: http://{{vm_ip}}:9090"
    @if command -v open >/dev/null 2>&1; then \
        open http://{{vm_ip}}:3000; \
        open http://{{vm_ip}}:9090; \
    elif command -v xdg-open >/dev/null 2>&1; then \
        xdg-open http://{{vm_ip}}:3000; \
        xdg-open http://{{vm_ip}}:9090; \
    else \
        echo "Manual access required"; \
    fi

# Watch logs in real-time
logs service="all":
    @echo "ğŸ“„ Watching {{service}} logs..."
    @if [ "{{service}}" = "all" ]; then \
        just compose logs; \
    else \
        just ssh-exec 'journalctl -u {{service}} -f'; \
    fi

# Debug VM issues
debug:
    @echo "ğŸ” Debug information for {{vm_name}}..."
    @echo "=== Terraform State ==="
    terraform show
    @echo ""
    @echo "=== VM Status ==="
    just health
    @echo ""
    @echo "=== Recent Logs ==="
    just ssh-exec 'sudo journalctl --since "10 minutes ago" --no-pager'

# ==================
# QUICK SHORTCUTS
# ==================

# Quick status check
status:
    @echo "ğŸ“Š {{vm_name}} Status:"
    terraform output vm5_info 2>/dev/null || echo "âŒ VM not deployed"

# One-command deployment and testing
deploy-and-test: deploy test-full
    @echo "ğŸ‰ {{vm_name}} deployed and tested successfully!"

# Emergency restart
restart-vm:
    @echo "ğŸ”„ Emergency restart of {{vm_name}}..."
    just ssh-exec 'sudo reboot'
    @echo "â³ Waiting 30 seconds for reboot..."
    sleep 30
    just test-basic

# Show current configuration
config:
    @echo "âš™ï¸  Current VM5 configuration:"
    @echo "  VM Name: {{vm_name}}"
    @echo "  VM IP: {{vm_ip}}"  
    @echo "  SSH User: {{ssh_user}}"
    @echo "  Terraform Dir: {{terraform_dir}}"